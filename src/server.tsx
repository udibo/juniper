import * as path from "@std/path";
import { HttpError } from "@udibo/http-error";
import { Hono } from "hono";
import type { Env, Schema } from "hono";
import { trimTrailingSlash } from "hono/trailing-slash";

import type { Client } from "@udibo/juniper/client";
import { getInstance } from "@udibo/juniper/utils/otel";

import { buildApp, createHandlers, mergeServerRoutes } from "./_server.tsx";
import type { Route } from "./_server.tsx";

/**
 * Creates a Hono application server with the provided route configuration.
 * The main entrypoint that uses this function is automatically generated by the build script.
 *
 * This function sets up error handling, trailing slash trimming, static file serving,
 * and builds the complete route tree from the provided configuration, merging both
 * client and server routes.
 *
 * @example Creating an application
 * ```ts
 * import { createServer } from "@udibo/juniper/server";
 * import { client } from "./main.tsx";
 *
 * export const server = createServer(import.meta.url, client, {
 *   path: "/",
 *   main: await import("./routes/main.ts"),
 *   children: [
 *     {
 *       path: "/api",
 *       main: await import("./routes/api/main.ts"),
 *       children: [
 *         {
 *           path: "/users",
 *           main: await import("./routes/api/users.ts"),
 *         }
 *       ]
 *     }
 *   ],
 * });
 *
 * if (import.meta.main) {
 *   Deno.serve(server.fetch);
 * }
 * ```
 *
 * @template E - Hono environment type
 * @template S - Hono schema type
 * @template BasePath - Base path string type
 *
 * @param moduleUrl - The URL of the module creating the server
 * @param client - The client configuration
 * @param routes - The server route configuration object
 * @returns A configured Hono application instance
 */
export function createServer<
  E extends Env = Env,
  S extends Schema = Schema,
  BasePath extends string = "/",
>(
  moduleUrl: string,
  client: Client,
  route: Route<E, S, BasePath>,
): Hono<E, S, BasePath> {
  const projectRoot = path.dirname(path.fromFileUrl(moduleUrl));
  const appWrapper = new Hono<E, S, BasePath>({ strict: true });

  appWrapper.onError((cause) => {
    const error = HttpError.from(cause);
    if (!error.instance) {
      const instance = getInstance();
      if (instance) {
        error.instance = instance;
      }
    }
    console.error(error);
    return error.getResponse();
  });
  appWrapper.use(trimTrailingSlash());

  const serverRoutes = mergeServerRoutes(route, client.routeObjects);
  const handlers = createHandlers(route, serverRoutes);
  const app = buildApp(route, client.rootRoute, handlers, projectRoot);

  appWrapper.route("/", app);
  return appWrapper;
}
